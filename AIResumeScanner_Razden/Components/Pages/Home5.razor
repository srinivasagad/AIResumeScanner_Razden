@page "/home5"
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject SentimentService MySentimentService
@inject TokenUsageService TokenUsageService
@using System.Web
@using iTextSharp.text;
@using iTextSharp.text.pdf;
@using Microsoft.Extensions.Azure;
@using System.Reflection.Metadata;
@using System.Text;
@using AIResumeScanner_Razden.Services;
@using Document = iTextSharp.text.Document;

<PageTitle>AI Resume Scanner</PageTitle>

<OverlaySpinner IsLoading=@showLoader></OverlaySpinner>

<div class="container-fluid">
    <div class="row">
        <!-- Main Content Area -->
        <div class="col-lg-9 col-md-8">
            <h2 class="mb-4">🔍 AI Resume Scanner</h2>

            <RadzenTemplateForm Data="@jobModel" TItem="JobModel" Submit="@HandleSubmit">
                <div class="form-grid" style="display: grid; gap: 20px; grid-template-columns: 1fr; max-width: 100%;">

                    <RadzenLabel Text="Provide Job Description" Component="JobDescription" />
                    <RadzenTextArea @bind-Value="jobModel.JobDescription"
                                    Name="JobDescription"
                                    Rows="5"
                                    Style="width:100%"
                                    Placeholder="Enter the job description here..." />

                    <div class="action-buttons">
                        <button type="submit"
                                class="chat-button primary @(isSubmitting || !HasEnoughTokens() ? "disabled" : "")"
                                disabled="@(isSubmitting || !HasEnoughTokens())">
                            @if (isSubmitting)
                            {
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>Processing...</span>
                            }
                            else
                            {
                                <i class="fas fa-paper-plane"></i>
                                <span>Submit</span>
                            }
                        </button>

                        <button type="button"
                                class="chat-button secondary"
                                @onclick="ClearTextArea">
                            <i class="fas fa-times"></i>
                            <span>Clear</span>
                        </button>

                        @if (showExport)
                        {
                            <button type="button"
                                    class="chat-button success"
                                    @onclick="ExportToCsv">
                                <i class="fas fa-file-csv"></i>
                                <span>Export CSV</span>
                            </button>

                            <button type="button"
                                    class="chat-button danger"
                                    @onclick="ExportToPdf">
                                <i class="fas fa-file-pdf"></i>
                                <span>Export PDF</span>
                            </button>
                        }

                        @if (conversationHistory.Count > 0)
                        {
                            <button type="button"
                                    class="chat-button warning"
                                    @onclick="ClearHistory">
                                <i class="fas fa-trash-alt"></i>
                                <span>Clear History</span>
                            </button>
                        }
                    </div>

                    @if (!HasEnoughTokens())
                    {
                        <div class="alert alert-danger" role="alert">
                            <strong>⚠️ Rate Limit Reached</strong>
                            <p class="mb-0">
                                You have only @TokenUsageService.GetRemainingTokensPerMinute() tokens remaining.
                                Please wait before submitting. (Resets in ~@GetSecondsUntilReset() seconds)
                            </p>
                        </div>
                    }
                </div>
            </RadzenTemplateForm>

            <br />

            <!-- Conversation History Section -->
            @if (conversationHistory.Count > 0)
            {
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">💬 Conversation History</h5>
                        <span class="badge bg-light text-dark">@conversationHistory.Count @(conversationHistory.Count == 1 ? "exchange" : "exchanges")</span>
                    </div>
                    <div class="card-body conversation-container">
                        @foreach (var exchange in conversationHistory)
                        {
                            <div class="conversation-exchange mb-4">
                                <!-- User Query -->
                                <div class="message-container user-message">
                                    <div class="message-header">
                                        <span class="message-role">
                                            <i class="fas fa-user"></i> You
                                        </span>
                                        <span class="message-time">@exchange.Timestamp.ToString("MMM dd, yyyy HH:mm:ss")</span>
                                    </div>
                                    <div class="message-content">
                                        @exchange.Query
                                    </div>
                                </div>

                                <!-- AI Response -->
                                <div class="message-container ai-message">
                                    <div class="message-header">
                                        <span class="message-role">
                                            <i class="fas fa-robot"></i> AI Assistant
                                        </span>
                                        @if (exchange.TokensUsed > 0)
                                        {
                                            <span class="badge bg-info">@exchange.TokensUsed tokens</span>
                                        }
                                    </div>
                                    <div class="message-content">
                                        @((MarkupString)exchange.Response)
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Current Response Section -->
            @if (!string.IsNullOrEmpty(chatResponse))
            {
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">💬 Current Response</h5>
                    </div>
                    <div class="card-body">
                        <div style="white-space: pre-wrap; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                            @((MarkupString)chatResponse)
                        </div>
                    </div>
                </div>
            }

            @if (isSubmitting)
            {
                <div class="card mb-4">
                    <div class="card-body text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Processing your request...</p>
                        <small class="text-muted">This may take a few moments</small>
                    </div>
                </div>
            }

            @if (currentAgent != null && !string.IsNullOrEmpty(chatResponse))
            {
                var stats = currentAgent.GetSessionStats();
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">📊 Session Statistics</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <small class="text-muted">Total Requests</small>
                                <div class="h5">@stats.RequestCount</div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Total Tokens</small>
                                <div class="h5">@stats.TotalTokens.ToString("N0")</div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Avg. per Request</small>
                                <div class="h5">@stats.AverageTokensPerRequest.ToString("F0")</div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Success Rate</small>
                                <div class="h5">@GetSuccessRate(stats)%</div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Sidebar with Token Widget -->
        <div class="col-lg-3 col-md-4">
            <!-- Token Usage Widget -->
            <TokenUsageWidget />

            <!-- Quick Stats Card -->
            <div class="card mt-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">📊 Session Info</h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <small class="text-muted">Session ID:</small>
                        <div class="text-truncate" title="@sessionId">
                            <code style="font-size: 0.75rem;">@sessionId.Substring(0, 8)...</code>
                        </div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Exchanges:</small>
                        <div>
                            <span class="badge bg-primary">@conversationHistory.Count</span>
                        </div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Exports Available:</small>
                        <div>
                            @if (showExport)
                            {
                                <span class="badge bg-success">Ready ✓</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Submit Query First</span>
                            }
                        </div>
                    </div>
                    @if (lastRequestTokens > 0)
                    {
                        <div class="mb-0 mt-3">
                            <small class="text-muted">Last Request:</small>
                            <div class="badge bg-primary">@lastRequestTokens tokens</div>
                        </div>
                    }
                </div>
            </div>

            <!-- Tips Card -->
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0">💡 Tips</h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled small mb-0">
                        <li class="mb-2">
                            <strong>✓</strong> Be specific in job descriptions
                        </li>
                        <li class="mb-2">
                            <strong>✓</strong> Include required skills and qualifications
                        </li>
                        <li class="mb-2">
                            <strong>✓</strong> Monitor token usage to avoid rate limits
                        </li>
                        <li class="mb-0">
                            <strong>✓</strong> Export results for offline review
                        </li>
                    </ul>
                </div>
            </div>

            <!-- View Full Dashboard Link -->
            <div class="mt-3 text-center">
                <a href="/token-history" class="btn btn-outline-primary btn-sm w-100">
                    📈 View Token History Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    .alert {
        border-radius: 8px;
        padding: 12px 16px;
    }

    .card {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card-header {
        border-radius: 8px 8px 0 0 !important;
    }

    .text-truncate {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .action-buttons {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: center;
    }

    .chat-button {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1.25rem;
        border: none;
        border-radius: 10px;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        min-width: 120px;
        justify-content: center;
    }

        .chat-button:hover:not(.disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .chat-button:active:not(.disabled) {
            transform: translateY(0);
        }

        .chat-button i {
            font-size: 0.875rem;
        }

        /* Primary Button (Submit) */
        .chat-button.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

            .chat-button.primary:hover:not(.disabled) {
                background: linear-gradient(135deg, #5568d3, #6a4091);
                box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
            }

            .chat-button.primary.disabled {
                background: linear-gradient(135deg, #a8a8a8, #909090);
                cursor: not-allowed;
                opacity: 0.6;
            }

        /* Secondary Button (Clear) */
        .chat-button.secondary {
            background: #f5f5f5;
            color: #666;
            border: 1px solid #e0e0e0;
        }

            .chat-button.secondary:hover {
                background: #e0e0e0;
                color: #333;
            }

        /* Success Button (Export CSV) */
        .chat-button.success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

            .chat-button.success:hover {
                background: linear-gradient(135deg, #45a049, #3d8b40);
                box-shadow: 0 4px 16px rgba(76, 175, 80, 0.4);
            }

        /* Danger Button (Export PDF) */
        .chat-button.danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

            .chat-button.danger:hover {
                background: linear-gradient(135deg, #d32f2f, #b71c1c);
                box-shadow: 0 4px 16px rgba(244, 67, 54, 0.4);
            }

        /* Warning Button (Clear History) */
        .chat-button.warning {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
        }

            .chat-button.warning:hover {
                background: linear-gradient(135deg, #f57c00, #e65100);
                box-shadow: 0 4px 16px rgba(255, 152, 0, 0.4);
            }

    /* Conversation History Styles */
    .conversation-container {
        max-height: 600px;
        overflow-y: auto;
        padding: 15px;
        background-color: #f8f9fa;
    }

    .conversation-exchange {
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 20px;
    }

        .conversation-exchange:last-child {
            border-bottom: none;
        }

    .message-container {
        margin-bottom: 15px;
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }

    .user-message {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        border-left: 4px solid #2196F3;
    }

    .ai-message {
        background: linear-gradient(135deg, #f3e5f5, #e1bee7);
        border-left: 4px solid #9c27b0;
    }

    .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .message-role {
        font-weight: 600;
        font-size: 0.9rem;
        color: #333;
    }

        .message-role i {
            margin-right: 5px;
        }

    .message-time {
        font-size: 0.75rem;
        color: #666;
    }

    .message-content {
        font-size: 0.9rem;
        line-height: 1.6;
        color: #333;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    /* Scrollbar Styling */
    .conversation-container::-webkit-scrollbar {
        width: 8px;
    }

    .conversation-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .conversation-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }

        .conversation-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

    /* Responsive */
    @@media (max-width: 768px) {
        .action-buttons {
            gap: 0.5rem;
        }

        .chat-button {
            min-width: 100px;
            padding: 0.5rem 1rem;
            font-size: 0.8125rem;
        }

            .chat-button i {
                font-size: 0.75rem;
            }

        .conversation-container {
            max-height: 400px;
        }

        .message-container {
            padding: 12px;
        }

        .message-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }
    }
</style>

@code {
    private JobModel jobModel = new();
    private List<Models.Result> resumeresults = new();
    private bool showLoader = false;
    private bool showExport = false;
    private bool isSubmitting = false;
    private string chatResponse = string.Empty;
    private SearchAgent2 currentAgent = null;
    private int lastRequestTokens = 0;

    // Conversation History
    private List<ConversationExchange> conversationHistory = new();

    [Inject]
    public IConfiguration _configuration { get; set; }

    // Azure OpenAI Configuration
    private string azureOpenAiEndpoint { get; set; } = string.Empty;
    private string azureOpenAiApiKey { get; set; } = string.Empty;
    private string chatDeploymentName { get; set; } = string.Empty;
    private string embeddingDeploymentName { get; set; } = string.Empty;

    // Azure AI Search Configuration
    private string searchEndpoint { get; set; } = string.Empty;
    private string searchIndexName { get; set; } = string.Empty;
    private string searchApiKey { get; set; } = string.Empty;
    private string textAnalyticsEndpoint { get; set; } = string.Empty;
    private string textAnalyticsApiKey { get; set; } = string.Empty;

    private string sessionId = Guid.NewGuid().ToString();

    // Inner class for conversation tracking
    private class ConversationExchange
    {
        public DateTime Timestamp { get; set; }
        public string Query { get; set; }
        public string Response { get; set; }
        public int TokensUsed { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        showLoader = false;
        azureOpenAiEndpoint = _configuration.GetSection("OpenAISettings")["AzureOpenAiEndpoint"];
        azureOpenAiApiKey = _configuration.GetSection("OpenAISettings")["AzureOpenAiApiKey"];
        chatDeploymentName = _configuration.GetSection("OpenAISettings")["ChatDeploymentName"];
        embeddingDeploymentName = _configuration.GetSection("OpenAISettings")["EmbeddingDeploymentName"];
        searchEndpoint = _configuration.GetSection("OpenAISettings")["SearchEndpoint"];
        searchIndexName = _configuration.GetSection("OpenAISettings")["SearchIndexName"];
        searchApiKey = _configuration.GetSection("OpenAISettings")["SearchApiKey"];
        textAnalyticsEndpoint = _configuration.GetSection("AzureTextAnalytics")["Endpoint"];
        textAnalyticsApiKey = _configuration.GetSection("AzureTextAnalytics")["ApiKey"];
    }

    private bool HasEnoughTokens()
    {
        // Check if we have at least 500 tokens available
        return TokenUsageService.GetRemainingTokensPerMinute() >= 500;
    }

    private int GetSecondsUntilReset()
    {
        // Calculate seconds until the next minute
        return 60 - DateTime.UtcNow.Second;
    }

    private int GetSuccessRate(SearchAgent2.TokenSessionStats stats)
    {
        if (stats.RequestCount == 0) return 0;
        return (int)((stats.SuccessfulRequests * 100.0) / stats.RequestCount);
    }

    private async Task HandleSubmit()
    {
        if (!HasEnoughTokens())
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = "Rate Limit",
                Detail = "Insufficient tokens available. Please wait before submitting.",
                Duration = 4000
            });
            return;
        }

        isSubmitting = true;
        showExport = false;
        chatResponse = string.Empty;
        lastRequestTokens = 0;

        try
        {
            var input = jobModel.JobDescription;

            if (string.IsNullOrWhiteSpace(input))
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Info,
                    Summary = "Empty Input",
                    Detail = "Please provide a job description.",
                    Duration = 3000
                });
                return;
            }

            // Record tokens before request
            var tokensBefore = TokenUsageService.GetTokensUsedLastMinute();

            // Create agent with TokenUsageService
            currentAgent = new SearchAgent2(
                azureOpenAiEndpoint,
                azureOpenAiApiKey,
                chatDeploymentName,
                embeddingDeploymentName,
                searchEndpoint,
                searchIndexName,
                searchApiKey,
                sessionId,
                textAnalyticsEndpoint,
                textAnalyticsApiKey,
                TokenUsageService // Pass the token service
            );

            // Track the start time for performance monitoring
            var startTime = DateTime.UtcNow;

            string response = await currentAgent.ChatAsync(input);

            chatResponse = response; // Don't encode since it contains HTML
            showExport = true;

            // Calculate actual time taken
            var duration = DateTime.UtcNow - startTime;

            // Calculate tokens used for this request
            var tokensAfter = TokenUsageService.GetTokensUsedLastMinute();
            lastRequestTokens = tokensAfter - tokensBefore;

            // Add to conversation history
            conversationHistory.Add(new ConversationExchange
            {
                Timestamp = DateTime.Now,
                Query = input,
                Response = response,
                TokensUsed = lastRequestTokens
            });

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Search Complete",
                Detail = $"Query processed successfully in {duration.TotalSeconds:F1}s using {lastRequestTokens} tokens",
                Duration = 4000
            });
        }
        catch (Exception ex)
        {
            chatResponse = $"❌ Error: {ex.Message}";

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = ex.Message,
                Duration = 5000
            });

            Console.WriteLine($"\nError: {ex.Message}");
            Console.WriteLine($"Stack: {ex.StackTrace}\n");
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    void ExportToCsv()
    {
        try
        {
            if (currentAgent == null)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "No Data",
                    Detail = "Please submit a query first.",
                    Duration = 3000
                });
                return;
            }

            var history = currentAgent.GetConversationHistory();
            string csvPath = $"conversation_history_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
            var sb = new StringBuilder();
            sb.AppendLine("Timestamp,Role,Content"); // CSV header

            foreach (var msg in history)
            {
                // Escape double quotes and commas in content
                string safeContent = msg.Content.Replace("\"", "\"\"");
                sb.AppendLine($"\"{msg.Timestamp:yyyy-MM-dd HH:mm:ss}\",\"{msg.Role}\",\"{safeContent}\"");
            }

            File.WriteAllText(csvPath, sb.ToString(), Encoding.UTF8);

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Export Successful",
                Detail = $"CSV saved to {csvPath}",
                Duration = 4000
            });
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Export Failed",
                Detail = ex.Message,
                Duration = 4000
            });
        }
    }

    void ExportToPdf()
    {
        try
        {
            if (currentAgent == null)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "No Data",
                    Detail = "Please submit a query first.",
                    Duration = 3000
                });
                return;
            }

            var history = currentAgent.GetConversationHistory();
            string pdfPath = $"conversation_history_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";

            // Create a new PDF document
            Document document = new Document(PageSize.A4, 40, 40, 40, 40);
            PdfWriter.GetInstance(document, new FileStream(pdfPath, FileMode.Create));
            document.Open();

            // Define fonts
            var titleFont = FontFactory.GetFont(FontFactory.HELVETICA_BOLD, 16);
            var roleFont = FontFactory.GetFont(FontFactory.HELVETICA_BOLD, 12, BaseColor.BLUE);
            var contentFont = FontFactory.GetFont(FontFactory.HELVETICA, 11);

            // Add title
            document.Add(new Paragraph("Conversation History", titleFont));
            document.Add(new Paragraph($"Exported on: {DateTime.Now:yyyy-MM-dd HH:mm:ss}\n\n"));

            // Add session info
            var stats = currentAgent.GetSessionStats();
            document.Add(new Paragraph($"Session ID: {sessionId}", contentFont));
            document.Add(new Paragraph($"Total Tokens Used: {stats.TotalTokens}\n\n", contentFont));

            // Add conversation entries
            foreach (var msg in history)
            {
                var header = new Paragraph($"[{msg.Timestamp:yyyy-MM-dd HH:mm:ss}] {msg.Role}:", roleFont);
                document.Add(header);

                var content = new Paragraph(msg.Content + "\n\n", contentFont);
                document.Add(content);
            }

            document.Close();

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Export Successful",
                Detail = $"PDF saved to {pdfPath}",
                Duration = 4000
            });
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Export Failed",
                Detail = ex.Message,
                Duration = 4000
            });
        }
    }

    void ClearTextArea()
    {
        jobModel.JobDescription = string.Empty;
        chatResponse = string.Empty;
        showExport = false;
        lastRequestTokens = 0;
        StateHasChanged();
    }

    void ClearHistory()
    {
        conversationHistory.Clear();
        chatResponse = string.Empty;
        showExport = false;
        lastRequestTokens = 0;

        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Info,
            Summary = "History Cleared",
            Detail = "Conversation history has been cleared.",
            Duration = 3000
        });

        StateHasChanged();
    }
}
